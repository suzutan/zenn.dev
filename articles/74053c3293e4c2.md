---
title: kubeadmã§æ§‹ç¯‰ã™ã‚‹kubernetesã§ã€ä»»æ„ã®è¨¼æ˜æ›¸ã‚’åˆ©ç”¨ã™ã‚‹æ–¹æ³•
emoji: ğŸŒ
type: tech
topics:
  - kubernetes
published: true
---

## TL;DR

kubeadm ãŒç™ºè¡Œã™ã‚‹è¨¼æ˜æ›¸ã® path ã«ã€ã‚ã‚‰ã‹ã˜ã‚è¨¼æ˜æ›¸ã‚’é…ç½®ã—ã¦ãŠã‘ã° kubeadm ã®è¨¼æ˜æ›¸ç™ºè¡ŒãŒã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã€ä»»æ„ã®è¨¼æ˜æ›¸ãŒç™ºè¡Œã§ãã‚‹ã€‚

## æ¦‚è¦

â€»ã“ã®è¨˜äº‹ã§ã¯ã€ kubernetes è¨¼æ˜æ›¸ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¯ `/etc/kubernetes/pki` ã‚’å‰æã¨ã—ãŸè¨˜è¿°ã‚’è¡Œã„ã¾ã™ã€‚

kubeadm ã‚’ç”¨ã„ã¦ kubernetes ã‚’æ§‹ç¯‰ã™ã‚‹éš›ã€åŸå‰‡ã¨ã—ã¦ã€è¨¼æ˜æ›¸ã®é¡ã„ã¯ kubeadm ãŒè‡ªå‹•ã§ç”Ÿæˆã—ã€ã‚¯ãƒ©ã‚¹ã‚¿ã®æ§‹ç¯‰ã‚’è¡Œã†ã€‚

ã“ã®ã¨ãã€CA ã‚’åˆã‚ã¦ã¨ã—ã€ã™ã¹ã¦è‡ªå·±ç½²åè¨¼æ˜æ›¸ç™ºè¡Œã•ã‚Œã‚‹ãŸã‚ã€kubernetes control plane ä»¥å¤–ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¡Œã„ãŸã„å ´åˆã€æ§‹ç¯‰ã‚’è¡Œã£ãŸå¾Œã« CA è¨¼æ˜æ›¸ç­‰ã‚’åˆ¥é€”æŒã¡å‡ºã™å¿…è¦ãŒã‚ã‚‹ã€‚

ã¾ãŸã€è‡ªåˆ†ãŒã‚ã‚‰ã‹ã˜ã‚ä½œæˆã—ã¦ã„ã‚‹ä»»æ„ã® CA è¨¼æ˜æ›¸ã‚’ç”¨ã„ã¦ã‚¯ãƒ©ã‚¹ã‚¿è¨¼æ˜æ›¸ã‚’ç™ºè¡Œã—ãŸã„å ´åˆã€IP ä»¥å¤–ã§ kube-apiserver ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã„å ´åˆã€kubelet ã®ã‚µãƒ¼ãƒãƒ¼è¨¼æ˜æ›¸ã«ä»»æ„ã® SANs ã‚’åŠ ãˆã‚‹å ´åˆã€`kubeadm init` ã‚³ãƒãƒ³ãƒ‰ã ã‘ã§ã¯ç›®çš„ã‚’é”æˆã§ããšã€å°‘ã—æ‰‹ã‚’åŠ ãˆã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚

ã“ã‚Œã‚’è§£æ±ºã™ã‚‹ãŸã‚ã€custom-certificates ã®æ©Ÿèƒ½ã‚’ç”¨ã„ã¦ã€è¨¼æ˜æ›¸ç™ºè¡Œã‚’ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ–ãƒ«ãªã‚‚ã®ã«ã—ã¦ã„ãã€‚

## ä»»æ„ã®è¨¼æ˜æ›¸ã‚’åˆ©ç”¨ã™ã‚‹ãŸã‚ã®åŸºç¤çŸ¥è­˜

kubeadm ã«ã¯ã€ã‚ã‚‰ã‹ã˜ã‚è¨¼æ˜æ›¸ãŒã‚»ãƒƒãƒˆã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ãã¡ã‚‰ã‚’åˆ©ç”¨ã™ã‚‹å½¢ã§è¨¼æ˜æ›¸ã‚’ç™ºè¡Œã—ã¦ãã‚Œã‚‹æ©Ÿèƒ½ãŒã‚ã‚‹ã€‚ã“ã‚Œã‚’åˆ©ç”¨ã™ã‚‹ã€‚
[Certificate Management with kubeadm | Kubernetes](https://kubernetes.io/docs/tasks/administer-cluster/kubeadm/kubeadm-certs/#custom-certificates)

ã¾ãŸã€æ—¢ã«æ§‹ç¯‰ãŒçµ‚ã‚ã£ã¦ãŠã‚Šã€ä»»æ„ã® è¨¼æ˜æ›¸ã‚’ç½®ãæ›ãˆãŸã„å ´åˆã¯ã€ cfssl ç­‰ã§ç™ºè¡Œã—ãŸè¨¼æ˜æ›¸ã§ä¸Šæ›¸ãã‚’ã—ã¦ã‹ã‚‰ã€ãƒ—ãƒ­ã‚»ã‚¹ã®å†èµ·å‹•ã‚’è¡Œã†ã€‚

### cert path ã«ã¤ã„ã¦

1. kubeadm config yaml ã‚’åˆ©ç”¨ã™ã‚‹å ´åˆã¯ã€ `/certificatesDir` ã§æŒ‡å®šã™ã‚‹ã€‚
2. `kubeadm init` ã®å¼•æ•°ã§ `--cert-dir` ã‚’åˆ©ç”¨ã™ã‚‹å ´åˆã¯ã€ `--cert-dir` ã§æŒ‡å®šã™ã‚‹ã€‚
3. ç‰¹ã«æŒ‡å®šã‚’ã—ãªã„å ´åˆã¯ã€ `/etc/kubernetes/pki` ãŒæŒ‡å®šã•ã‚Œã‚‹ã€‚

### kubeadm ãŒç™ºè¡Œã™ã‚‹è¨¼æ˜æ›¸ä¸€è¦§ã«ã¤ã„ã¦

`kubeadm init` ã‚’è¡Œã£ãŸéš›ã«ã€ `/etc/kubernetes/pki` é…ä¸‹ã«ä»¥ä¸‹ã®è¨¼æ˜æ›¸ãŒç™ºè¡Œã•ã‚Œã‚‹ã€‚

```bash
apiserver.crt
apiserver-etcd-client.crt
apiserver-etcd-client.key
apiserver.key
apiserver-kubelet-client.crt
apiserver-kubelet-client.key
ca.crt
ca.key
front-proxy-ca.crt
front-proxy-ca.key
front-proxy-client.crt
front-proxy-client.key
sa.key
sa.pub
etcd/ca.crt
etcd/ca.key
etcd/healthcheck-client.crt
etcd/healthcheck-client.key
etcd/peer.crt
etcd/peer.key
etcd/server.crt
etcd/server.key
```

ã¾ãŸã€kubelet è¨¼æ˜æ›¸ã«é–¢ã—ã¦ã¯ã€ `/var/lib/kubelet/pki` ã«é…ç½®ã•ã‚Œã‚‹ã€‚ã“ã®ä¸­ã‹ã‚‰ã€ `kubelet_endpoint:10250` ã§ listen ã—ã¦ã„ã‚‹ã®ã¯ `kubelet.crt` ã§ã‚ã‚‹ã€‚

```bash
$ ls -l /var/lib/kubelet/pki
total 12
-rw------- 1 root root 2847 Apr 18 19:50 kubelet-client-2021-04-18-19-50-34.pem
lrwxrwxrwx 1 root root   59 Apr 18 19:50 kubelet-client-current.pem -> /var/lib/kubelet/pki/kubelet-client-2021-04-18-19-50-34.pem
-rw-r--r-- 1 root root 1399 May  2 09:25 kubelet.crt
-rw------- 1 root root 1679 May  2 09:25 kubelet.key

```

CertificateDir é…ä¸‹ã®è¨¼æ˜æ›¸ã‚’ã‚ã‚‰ã‹ã˜ã‚é…ç½®ã—ã¦ãŠã‘ã°ã€å¯¾è±¡è¨¼æ˜æ›¸ã®ç”Ÿæˆã¯ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã‚‹ä»•æ§˜ã¨ãªã£ã¦ã„ã‚‹ãŸã‚ã€è‡ªåˆ†ãŒç½®ãæ›ãˆãŸã„è¨¼æ˜æ›¸ã‚’ã‚ã‚‰ã‹ã˜ã‚ä»»æ„ã®æ–¹æ³•ã§ç™ºè¡Œã—ã¦ãŠãã€ `/etc/kubernetes/pki` é…ä¸‹ã«é…ç½®ã—ã¦ã‹ã‚‰ `kubeadm init` ã‚’è¡Œã†ã€‚

## ä»»æ„ã® CA è¨¼æ˜æ›¸ã‚’ä½¿ã†

è‡ªåˆ†ã§ç™ºè¡Œã—ãŸèªè¨¼å±€ã‚’ä½¿ã„ãŸã„å ´åˆã¯ã€ä»¥ä¸‹ã® path ã«é…ç½®ã™ã‚‹ã€‚

- `/etc/kubernetes/pki/ca.crt`
- `/etc/kubernetes/pki/ca.key`

## kube-apiserver ã®è¨¼æ˜æ›¸ã« SANs ã‚’è¿½åŠ ã—ãŸã„

ä»¥ä¸‹ã® path ã«è¨¼æ˜æ›¸ã‚’é…ç½®ã™ã‚‹ã€‚

- `/etc/kubernetes/pki/apiserver.crt`
- `/etc/kubernetes/pki/apiserver.key`

apiserver ã«ã¤ã„ã¦ã¯ã€ `kubeadm init` æ™‚ã«ã€ `--apiserver-cert-extra-sans` å¼•æ•°ã§ SANs ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ãŸã‚ã€è‡ªèº«ã§ç™ºè¡Œã›ãšã¨ã‚‚ SANs è¿½åŠ å¯¾å¿œãŒè¡Œãˆã‚‹ã€‚
æ—¢ã« `kubeadm init` æ¸ˆã®å ´åˆã¯ã€ ca.crt, ca.key ã‚’ç”¨ã„ã¦ apiserver.crt, apiserver.key ã‚’ç™ºè¡Œã—ç›´ã™å¿…è¦ãŒã‚ã‚‹ã€‚

## kubelet ã‚µãƒ¼ãƒãƒ¼è¨¼æ˜æ›¸ã«å¯¾ã—ã¦ SANs ã‚’è¿½åŠ ã—ãŸã„

### çµŒç·¯

(kubelet ã‚µãƒ¼ãƒãƒ¼è¨¼æ˜æ›¸ã«å¯¾ã—ã¦ä»»æ„ã® SANs ã‚’å‹•ã‹ã—ãŸã„ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ã€ã‘ã£ã“ã†é™å®šçš„ãªã‚“ã§ã™ãŒ)
kubeadm ãŒè‡ªå‹•ç™ºè¡Œã™ã‚‹è¨¼æ˜æ›¸ã¯ã€node ã® IP ã®ã¿ã‚’ SANs ã«è¨­å®šã™ã‚‹ãŸã‚ã€metrics-server ãŒ `https://<nodeã®FQDN>:10250` ã«å¯¾ã—ã¦ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¡Œã£ãŸéš›ã« invalid certificate ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã— metrics-server ãŒæ­£å¸¸ã«èµ·å‹•ã—ãªã‹ã£ãŸã“ã¨ãŒã‚ã£ãŸãŸã‚ã€ã“ã®å¯¾å¿œã‚’è¡Œã£ãŸã€‚

### ã‚„ã‚Šã‹ãŸ

ã“ã¡ã‚‰ã¯ã€ä»»æ„ã®æ–¹æ³•ã§è¨¼æ˜æ›¸ã‚’ç™ºè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚cfssl ãŒæ¥½ã€‚

cfssl ã‚’ç”¨ã„ãŸè¨¼æ˜æ›¸ã®ç™ºè¡Œã¨ã‹ã«ã¤ã„ã¦ã¯ [cloudflare/cfssl: CFSSL: Cloudflare's PKI and TLS toolkit](https://github.com/cloudflare/cfssl) ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

node FQDN ã‚’ SANs ã«è¿½åŠ ã—ãŸã‚µãƒ¼ãƒãƒ¼è¨¼æ˜æ›¸ã‚’ã€ä»¥ä¸‹ã® path ã«é…ç½®ã—ã€ `kubeadm init` ãªã„ã—ã€ `systemctl restart kubelet` ã‚’è¡Œãˆã°å¯¾å¿œå®Œäº†ã¨ãªã‚‹ã€‚

ä»¥ä¸‹ã® path ã«è¨¼æ˜æ›¸ã‚’é…ç½®ã™ã‚‹ã€‚

- `/var/lib/kubelet/pki/kubelet.crt`
- `/var/lib/kubelet/pki/kubelet.key`

ä»¥ä¸Š
