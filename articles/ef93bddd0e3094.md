---
title: GitHub AppsçµŒç”±ã§ç™ºè¡Œã—ãŸtokenã‚’ç”¨ã„ã¦ã€GitHub Actionsã§ä½¿ã†
emoji: ğŸ”‘
type: tech
topics:
  - githubactions
published: true
date updated: 2021-11-27 05:40
---

## ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³

1. github actionã§ã€`secrets.GITHUB_TOKEN` ã®æ¨©é™ã‚’è¶…ãˆã¦GitHubã‚’æ“ä½œã™ã‚‹å ´åˆã€Personal Access Tokenã‚’ä½¿ã£ã¦æ“ä½œã™ã‚‹ã“ã¨ãŒå¤šã„ã€‚
2. Personal Access Tokenã¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®éƒ½åˆä¸Šã€æœ‰åŠ¹æœŸé™ã‚’è¨­å®šã™ã‚‹ã“ã¨ãŒãƒ™ã‚¿ãƒ¼ã¨ã•ã‚Œã¦ãŠã‚Šã€ç„¡æœŸé™ã§ä½œæˆã—ãŸããªã„ã€‚
3. å€‹äººã§ç®¡ç†ã™ã‚‹repoãªã©ã§ã‚ã‚Œã°â†‘ã§ã‚‚å•é¡Œãªã„ãŒã€Organizationã§è¤‡æ•°äººãŒç®¡ç†ã™ã‚‹å ´åˆã€å€‹äººã®Access Tokenã‚’ä½¿ã†ã“ã¨ã¯ãã‚‚ãã‚‚é¿ã‘ãŸã„ã€‚
4. GitHub Appsã‚’ç”¨ã„ã¦ãƒãƒ¼ãƒ ç®¡ç†Tokenã‚’æ‰•ã„å‡ºã™ï¼ˆæ„è¨³ï¼‰ã“ã¨ã§ã€Personal Access Tokenã«ä¾å­˜ã›ãšã«ã€`secrets.GITHUB_TOKEN` ã®æ¨©é™ã‚’è¶…ãˆã¦GitHubã‚’æ“ä½œã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚

## ã‚´ãƒ¼ãƒ«

Organizationé…ä¸‹ã®ãƒªãƒã‚¸ãƒˆãƒªä¸Šã®GitHub Actionsã§ã€`secrets.GITHUB_TOKEN`ã®æ¨©é™ã‚’è¶…ãˆãŸæ“ä½œãŒè¡Œãˆã¦ã„ã‚‹ã€‚

## æµã‚Œ

1. GitHub Appsã‚’Organizationé…ä¸‹ã«ä½œæˆã™ã‚‹
2. Organizationã«ã€[1]ã§ä½œæˆã—ãŸGitHub Appsã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹
3. GitHub Appsã®App IDã¨ã€ç™ºè¡Œã—ãŸPrivate Keyã‚’å–å¾—ã—ã€secretsã«ç™»éŒ²ã™ã‚‹
4. GitHub Actionsä¸Šã§tokenã‚’å–å¾—ã™ã‚‹

## GitHub Appsã‚’Organizationé…ä¸‹ã«ä½œæˆã™ã‚‹

<<https://github.com/organizations/><org_name>/settings/apps/new> ã‚ˆã‚Šã€GitHub Appsã‚’ä½œæˆã™ã‚‹ã€‚

ä¾‹ã¨ã—ã¦ã€ä»¥ä¸‹æƒ…å ±ã§è¨­å®šã‚’è¡Œã£ã¦ã„ã‚‹ã€‚

- org: harvestasya
- GitHub App name: `sample app`
- Homepage URL: `https://example.com`
- Webhook/Active: false

App Nameã¨Homepage URLã¯ä»»æ„ã®ã‚‚ã®ã‚’å…¥ã‚Œã‚‹

![](Pasted%20image%2020211127045245.png)

Permissionã«ã¤ã„ã¦ã¯ã€

- (GitHub ActionsãŒPrivate repositoryä¸Šã§å®Ÿè¡Œã•ã‚Œã‚‹å ´åˆ)ã€€`Repository permissions -> Administration` ã‚’ `Read-only` ã«è¨­å®šã™ã‚‹
  - ![](Pasted%20image%2020211127045149.png)
- ãã®ä»–ã«ã¤ã„ã¦ã¯ã€GitHub Actionsä¸Šã§è¡Œã„ãŸã„æ“ä½œã«åŸºã¥ã„ã¦æ¨©é™ã‚’è¨­å®šã™ã‚‹
  - org memberã‚’ç®¡ç†ã—ãŸã„å ´åˆã¯ã€ `Organization permissions -> Members` ãªã©ã€‚

`Where can this GitHub App be installed?` ã«ã¤ã„ã¦ã¯ã€è‡ªorgã§ã®ã¿ä½¿ãˆã‚Œã°è‰¯ã„ã®ã§ `Only on this account` ã‚’é¸æŠã™ã‚‹ã€‚

![](Pasted%20image%2020211127045414.png)

## Organizationã«ã€ä½œæˆã—ãŸGitHub Appsã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹

GitHub Appã‚’ä½œæˆã—ãŸã‚‰ã€å·¦ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«ã‚ã‚‹ `Install App` ã«è¡Œãã€Installãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦Organizationã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹.

![](Pasted%20image%2020211127045621.png)

ã©ã®ãƒªãƒã‚¸ãƒˆãƒªã‚’readã•ã›ã‚‹ã‹ã¯ä»»æ„ã§ã€‚

![](Pasted%20image%2020211127045650.png)

## GitHub Appsã‚’æ“ä½œã™ã‚‹ãŸã‚ã®Private keyã‚’ç™ºè¡Œã™ã‚‹

GitHub Appsã§tokenå–å¾—ã‚’è¡Œã†ãŸã‚ã«ã€Private keyã‚’ç™ºè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚

GitHub Appsã®Generalé …ç›®ã‚’ä¸‹ã«ãŸã©ã‚‹ã¨ã€ `Private keys` é …ç›®ãŒã‚ã‚‹ã®ã§ã€ `Generate a private key`ã§ç§˜å¯†éµã‚’ä½œæˆã™ã‚‹ã€‚

![](Pasted%20image%2020211127045831.png)

ã§ããŸã‚„ã¤

![](Pasted%20image%2020211127045851.png)

## GitHub Appsã®App IDã¨ã€ç™ºè¡Œã—ãŸPrivate Keyã‚’å–å¾—ã—ã€secretsã«ç™»éŒ²ã™ã‚‹

ã“ã“ã‹ã‚‰ã€GitHub Actionsã‚’å‹•ã‹ã™ãƒªãƒã‚¸ãƒˆãƒªã®Settingsã«ç§»å‹•ã™ã‚‹ã€‚

`Organization secrets` ã‹ `Repository secrets` ã‹ã¯ä»»ã›ã‚‹ãŒã€ã¨ã«ã‹ãSecretã‚’ç™»éŒ²ã™ã‚‹ã€‚

![](Pasted%20image%2020211127050101.png)

- APP_ID: 154715
- PRIVATE_KEY: `-----BEGIN RSA PRIVATE KEY-----` ã§å§‹ã¾ã‚‹è¤‡æ•°è¡Œ

![](Pasted%20image%2020211127050203.png)

## GitHub Actionsä¸Šã§tokenã‚’å–å¾—ã™ã‚‹

github actionsä¸Šã§GitHub Appsã«ã‚ˆã‚‹tokenã‚’å–å¾—ã™ã‚‹ã®ã«ã€ `tibdex/github-app-token` ã®actionsã‚’åˆ©ç”¨ã™ã‚‹ã€‚

ã¨ã‚Šã‚ãˆãšå–å¾—ã™ã‚‹ã ã‘ã®ã‚µãƒ³ãƒ—ãƒ«workflowã‚’ä¸‹è¨˜ã«è¨˜è¼‰ã™ã‚‹

```yaml
name: CI
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
jobs:
  terraform:
    name: test
    runs-on: ubuntu-latest

    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Generate github token
        id: generate_token
        uses: tibdex/github-app-token@v1
        with:
          app_id: ${{ secrets.APP_ID }}
          private_key: ${{ secrets.PRIVATE_KEY }}
      - name: use token
        run: echo "$GITHUB_TOKEN"
        env:
          GITHUB_TOKEN: ${{ steps.generate_token.outputs.token }}

```

`uses: tibdex/github-app-token@v1` ã®outputã«tokenãŒæ ¼ç´ã•ã‚Œã‚‹ãŸã‚ã€ `${{ steps.generate_token.outputs.token }}` ã¨ã‹ã§tokenã‚’æŒã£ã¦ãã¦ã€ä»»æ„ã®èªè¨¼ã«ä½¿ãˆã°ã‚ˆã„ã€‚

![](Pasted%20image%2020211127051620.png)

## ã•ã„ã”ã«

Personal Access Tokenã¯åˆå‹•ã¯ã¨ã¦ã‚‚ã‚³ã‚¹ãƒˆãŒä½ãã¦ä¾¿åˆ©ã ãŒã€çµ„ç¹”ã§ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã‚’ã—ã¦ã„ãå ´åˆã¯å¾Œã®é‹ç”¨ã‚³ã‚¹ãƒˆã®ã»ã†ãŒé«˜ããªã‚‹ãŸã‚ã€GitHub Appsã‚’ç”¨ã„ã¦ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã™ã‚‹ã»ã†ãŒä¸­é•·æœŸçš„ã«è¦‹ã¦é‹ç”¨ã‚³ã‚¹ãƒˆã¯ä¸‹ãŒã‚‹ã€‚
GitHub Appsã¯ã¾ã ãƒ¡ã‚¸ãƒ£ãƒ¼ã«ä½¿ã‚ã‚Œã¦ã„ãªã„å°è±¡ã§ã¯ã‚ã‚‹ãŒã€ä¸€åº¦ä½¿ã„æ–¹ã‚’è¦šãˆã¦ã—ã¾ãˆã°ã“ã¡ã‚‰ã®ã»ã†ãŒã„ã‚ã„ã‚ã¨ä¾¿åˆ©ã€‚
