---
title: GitHub AppsçµŒç”±ã§ç™ºè¡Œã—ãŸtokenã‚’ç”¨ã„ã¦ã€GitHub Actionsã§ä½¿ã†
emoji: ğŸ”‘
type: tech
topics:
  - githubactions
published: true
date updated: 2021-11-27 05:40
---

## ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³

1. github action ã§ã€`secrets.GITHUB_TOKEN` ã®æ¨©é™ã‚’è¶…ãˆã¦ GitHub ã‚’æ“ä½œã™ã‚‹å ´åˆã€Personal Access Token ã‚’ä½¿ã£ã¦æ“ä½œã™ã‚‹ã“ã¨ãŒå¤šã„ã€‚
2. Personal Access Token ã¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®éƒ½åˆä¸Šã€æœ‰åŠ¹æœŸé™ã‚’è¨­å®šã™ã‚‹ã“ã¨ãŒãƒ™ã‚¿ãƒ¼ã¨ã•ã‚Œã¦ãŠã‚Šã€ç„¡æœŸé™ã§ä½œæˆã—ãŸããªã„ã€‚
3. å€‹äººã§ç®¡ç†ã™ã‚‹ repo ãªã©ã§ã‚ã‚Œã° â†‘ ã§ã‚‚å•é¡Œãªã„ãŒã€Organization ã§è¤‡æ•°äººãŒç®¡ç†ã™ã‚‹å ´åˆã€å€‹äººã® Access Token ã‚’ä½¿ã†ã“ã¨ã¯ãã‚‚ãã‚‚é¿ã‘ãŸã„ã€‚
4. GitHub Apps ã‚’ç”¨ã„ã¦ãƒãƒ¼ãƒ ç®¡ç† Token ã‚’æ‰•ã„å‡ºã™ï¼ˆæ„è¨³ï¼‰ã“ã¨ã§ã€Personal Access Token ã«ä¾å­˜ã›ãšã«ã€`secrets.GITHUB_TOKEN` ã®æ¨©é™ã‚’è¶…ãˆã¦ GitHub ã‚’æ“ä½œã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚

## ã‚´ãƒ¼ãƒ«

Organization é…ä¸‹ã®ãƒªãƒã‚¸ãƒˆãƒªä¸Šã® GitHub Actions ã§ã€`secrets.GITHUB_TOKEN`ã®æ¨©é™ã‚’è¶…ãˆãŸæ“ä½œãŒè¡Œãˆã¦ã„ã‚‹ã€‚

## æµã‚Œ

1. GitHub Apps ã‚’ Organization é…ä¸‹ã«ä½œæˆã™ã‚‹
2. Organization ã«ã€[1]ã§ä½œæˆã—ãŸ GitHub Apps ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹
3. GitHub Apps ã® App ID ã¨ã€ç™ºè¡Œã—ãŸ Private Key ã‚’å–å¾—ã—ã€secrets ã«ç™»éŒ²ã™ã‚‹
4. GitHub Actions ä¸Šã§ token ã‚’å–å¾—ã™ã‚‹

## GitHub Apps ã‚’ Organization é…ä¸‹ã«ä½œæˆã™ã‚‹

<<https://github.com/organizations/><org_name>/settings/apps/new> ã‚ˆã‚Šã€GitHub Apps ã‚’ä½œæˆã™ã‚‹ã€‚

ä¾‹ã¨ã—ã¦ã€ä»¥ä¸‹æƒ…å ±ã§è¨­å®šã‚’è¡Œã£ã¦ã„ã‚‹ã€‚

- org: harvestasya
- GitHub App name: `sample app`
- Homepage URL: `https://example.com`
- Webhook/Active: false

App Name ã¨ Homepage URL ã¯ä»»æ„ã®ã‚‚ã®ã‚’å…¥ã‚Œã‚‹

![](/images/ef93bddd0e3094/Pasted%20image%2020211127045245.png)

Permission ã«ã¤ã„ã¦ã¯ã€

- (GitHub Actions ãŒ Private repository ä¸Šã§å®Ÿè¡Œã•ã‚Œã‚‹å ´åˆ)ã€€`Repository permissions -> Administration` ã‚’ `Read-only` ã«è¨­å®šã™ã‚‹
  - ![](/images/ef93bddd0e3094/Pasted%20image%2020211127045149.png)
- ãã®ä»–ã«ã¤ã„ã¦ã¯ã€GitHub Actions ä¸Šã§è¡Œã„ãŸã„æ“ä½œã«åŸºã¥ã„ã¦æ¨©é™ã‚’è¨­å®šã™ã‚‹
  - org member ã‚’ç®¡ç†ã—ãŸã„å ´åˆã¯ã€ `Organization permissions -> Members` ãªã©ã€‚

`Where can this GitHub App be installed?` ã«ã¤ã„ã¦ã¯ã€è‡ª org ã§ã®ã¿ä½¿ãˆã‚Œã°è‰¯ã„ã®ã§ `Only on this account` ã‚’é¸æŠã™ã‚‹ã€‚

![](/images/ef93bddd0e3094/Pasted%20image%2020211127045414.png)

## Organization ã«ã€ä½œæˆã—ãŸ GitHub Apps ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹

GitHub App ã‚’ä½œæˆã—ãŸã‚‰ã€å·¦ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«ã‚ã‚‹ `Install App` ã«è¡Œãã€Install ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ Organization ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹.

![](/images/ef93bddd0e3094/Pasted%20image%2020211127045621.png)

ã©ã®ãƒªãƒã‚¸ãƒˆãƒªã‚’ read ã•ã›ã‚‹ã‹ã¯ä»»æ„ã§ã€‚

![](/images/ef93bddd0e3094/Pasted%20image%2020211127045650.png)

## GitHub Apps ã‚’æ“ä½œã™ã‚‹ãŸã‚ã® Private key ã‚’ç™ºè¡Œã™ã‚‹

GitHub Apps ã§ token å–å¾—ã‚’è¡Œã†ãŸã‚ã«ã€Private key ã‚’ç™ºè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚

GitHub Apps ã® General é …ç›®ã‚’ä¸‹ã«ãŸã©ã‚‹ã¨ã€ `Private keys` é …ç›®ãŒã‚ã‚‹ã®ã§ã€ `Generate a private key`ã§ç§˜å¯†éµã‚’ä½œæˆã™ã‚‹ã€‚

![](/images/ef93bddd0e3094/Pasted%20image%2020211127045831.png)

ã§ããŸã‚„ã¤

![](/images/ef93bddd0e3094/Pasted%20image%2020211127045851.png)

## GitHub Apps ã® App ID ã¨ã€ç™ºè¡Œã—ãŸ Private Key ã‚’å–å¾—ã—ã€secrets ã«ç™»éŒ²ã™ã‚‹

ã“ã“ã‹ã‚‰ã€GitHub Actions ã‚’å‹•ã‹ã™ãƒªãƒã‚¸ãƒˆãƒªã® Settings ã«ç§»å‹•ã™ã‚‹ã€‚

`Organization secrets` ã‹ `Repository secrets` ã‹ã¯ä»»ã›ã‚‹ãŒã€ã¨ã«ã‹ã Secret ã‚’ç™»éŒ²ã™ã‚‹ã€‚

![](/images/ef93bddd0e3094/Pasted%20image%2020211127050101.png)

- APP_ID: 154715
- PRIVATE_KEY: `-----BEGIN RSA PRIVATE KEY-----` ã§å§‹ã¾ã‚‹è¤‡æ•°è¡Œ

![](/images/ef93bddd0e3094/Pasted%20image%2020211127050203.png)

## GitHub Actions ä¸Šã§ token ã‚’å–å¾—ã™ã‚‹

github actions ä¸Šã§ GitHub Apps ã«ã‚ˆã‚‹ token ã‚’å–å¾—ã™ã‚‹ã®ã«ã€ `tibdex/github-app-token` ã® actions ã‚’åˆ©ç”¨ã™ã‚‹ã€‚

ã¨ã‚Šã‚ãˆãšå–å¾—ã™ã‚‹ã ã‘ã®ã‚µãƒ³ãƒ—ãƒ« workflow ã‚’ä¸‹è¨˜ã«è¨˜è¼‰ã™ã‚‹

```yaml
name: CI
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
jobs:
  terraform:
    name: test
    runs-on: ubuntu-latest

    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Generate github token
        id: generate_token
        uses: tibdex/github-app-token@v1
        with:
          app_id: ${{ secrets.APP_ID }}
          private_key: ${{ secrets.PRIVATE_KEY }}
      - name: use token
        run: echo "$GITHUB_TOKEN"
        env:
          GITHUB_TOKEN: ${{ steps.generate_token.outputs.token }}
```

`uses: tibdex/github-app-token@v1` ã® output ã« token ãŒæ ¼ç´ã•ã‚Œã‚‹ãŸã‚ã€ `${{ steps.generate_token.outputs.token }}` ã¨ã‹ã§ token ã‚’æŒã£ã¦ãã¦ã€ä»»æ„ã®èªè¨¼ã«ä½¿ãˆã°ã‚ˆã„ã€‚

![](/images/ef93bddd0e3094/Pasted%20image%2020211127051620.png)

## ã•ã„ã”ã«

Personal Access Token ã¯åˆå‹•ã¯ã¨ã¦ã‚‚ã‚³ã‚¹ãƒˆãŒä½ãã¦ä¾¿åˆ©ã ãŒã€çµ„ç¹”ã§ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã‚’ã—ã¦ã„ãå ´åˆã¯å¾Œã®é‹ç”¨ã‚³ã‚¹ãƒˆã®ã»ã†ãŒé«˜ããªã‚‹ãŸã‚ã€GitHub Apps ã‚’ç”¨ã„ã¦ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã™ã‚‹ã»ã†ãŒä¸­é•·æœŸçš„ã«è¦‹ã¦é‹ç”¨ã‚³ã‚¹ãƒˆã¯ä¸‹ãŒã‚‹ã€‚
GitHub Apps ã¯ã¾ã ãƒ¡ã‚¸ãƒ£ãƒ¼ã«ä½¿ã‚ã‚Œã¦ã„ãªã„å°è±¡ã§ã¯ã‚ã‚‹ãŒã€ä¸€åº¦ä½¿ã„æ–¹ã‚’è¦šãˆã¦ã—ã¾ãˆã°ã“ã¡ã‚‰ã®ã»ã†ãŒã„ã‚ã„ã‚ã¨ä¾¿åˆ©ã€‚
